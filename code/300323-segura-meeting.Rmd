---
title: "300323-segura-meeting"
output: html_document
date: "2023-03-29"
---

### load libraries
```{r, load}
library(tidyverse)
library(dplyr)
```

### Write function to collect data for epidermis and dermis into two dataframes
```{r, txt-to-df}
# write code in R to turn multiple txt files into one dataframe where each column corresponds to one txt file

# set working directory to folder containing txt files
collect_data <- function(path_to_folder_with_txts_as_string, file_name, type="txt"){
  # set your working directory to the folder where your txt files are located
setwd(path_to_folder_with_txts_as_string)

# create a list of all the txt files in the folder
txt_files <- list.files(pattern = "\\.txt$")

# create an empty dataframe to hold the data
combined_df <- data.frame()

# loop through each txt file and append it to the dataframe
for (file in txt_files) {
  # read in the txt file as a dataframe
  temp_df <- read.table(file, header = TRUE)
  # append NA values to make sure all columns have the same length
  if (nrow(temp_df) < nrow(combined_df)) {
    temp_df[(nrow(temp_df)+1):nrow(combined_df),] <- NA
  } else if (nrow(temp_df) > nrow(combined_df)) {
    combined_df[(nrow(combined_df)+1):nrow(temp_df),] <- NA
  }
  # combine the temp dataframe with the combined dataframe
  combined_df <- cbind(combined_df, temp_df)
}

# rename the columns to match the original file names
colnames(combined_df) <- txt_files

# view the final dataframe
combined_df

  
  return(combined_df)
}

# In this code, setwd() sets the working directory to the folder containing the txt files. The list.files() function creates a vector of all txt file names in the directory. The data.frame() function creates an empty dataframe to store the combined data. The for loop reads in data from each txt file and appends it to the combined_data dataframe using the cbind() function. Finally, the colnames() function renames the columns of the dataframe with the names of the txt files.

#This code assumes that all of the txt files have the same structure and that they all have headers. 



```

### Collect micron epidermis and dermis pixel (unaltered) data into two dataframes
```{r, use-collect-data-function-epidermis, warning=FALSE}
# collect all epidermis data
  # set path
path_to_folder <- "../data/Epidermal-thickness-prism"
  #check path
list.files(path_to_folder)

all_epidermis<-collect_data(path_to_folder)
```

```{r, use-collect-data-function-dermis, warning=FALSE}
# collect all dermis data
path_to_folder2 <- "../data/Dermal-thickness-prism"
  #check path
list.files(path_to_folder2)

all_dermis<-collect_data(path_to_folder2)
```

### Save the epidermis and dermis pixel dataframes as csv files
```{r, save-dermis-and-epidermis-dfs}
## ONLY RUN IF DATAFRAMS NOT ALREADY SAVED!

write.csv(all_epidermis, file=paste0("../data/","all_epidermis_lengths_in_pixels.csv"))
write.csv(all_dermis, file=paste0("../data/","all_dermis_lengths_in_pixels.csv"))
```

### rename epidermis and dermis df for readability
```{r, load-pixel-epiderm-derm}
all_dermis_lengths_in_pixels <- all_dermis
all_epidermis_lengths_in_pixels <- all_epidermis
```

### visualize spread of each animal's pixel lengths...
#### spread of each animal's pixel lengths for epidermis
```{r, spread-epi-pixel}
df_set1<-all_epidermis_lengths_in_pixels[,1:6]
df_set2<-all_epidermis_lengths_in_pixels[,7:12]
df_set3<-all_epidermis_lengths_in_pixels[,13:18]
df_set4<-all_epidermis_lengths_in_pixels[,19:24]
df_set5<-all_epidermis_lengths_in_pixels[,25:30]

# convert data to long format using tidyr::pivot_longer()
long1 <- tidyr::pivot_longer(df_set1, everything())
long2 <- tidyr::pivot_longer(df_set2, everything())
long3 <- tidyr::pivot_longer(df_set3, everything())
long4 <- tidyr::pivot_longer(df_set4, everything())
long5 <- tidyr::pivot_longer(df_set5, everything())

# plot using ggplot and facet_wrap()
p1<-ggplot(long1[], aes(x = value)) +
  geom_histogram(color="black", fill="white") +
  facet_wrap(~ name, scales = "free") +
  labs(x = "Pixel Value", y = "Frequency")
p1
ggsave("animal-pixel-lenght-spread1.jpg", plot = p1, dpi = 300, width = 6, height = 4, units = "in")

p2<-ggplot(long2[], aes(x = value)) +
  geom_histogram(color="black", fill="white") +
  facet_wrap(~ name, scales = "free") +
  labs(x = "Pixel Value", y = "Frequency")
p2
ggsave("animal-pixel-lenght-spread2.jpg", plot = p2, dpi = 300, width = 6, height = 4, units = "in")

p3<-ggplot(long3[], aes(x = value)) +
  geom_histogram(color="black", fill="white") +
  facet_wrap(~ name, scales = "free") +
  labs(x = "Pixel Value", y = "Frequency")
ggsave("animal-pixel-lenght-spread3.jpg", plot = p3, dpi = 300, width = 6, height = 4, units = "in")

p4<-ggplot(long4[], aes(x = value)) +
  geom_histogram(color="black", fill="white") +
  facet_wrap(~ name, scales = "free") +
  labs(x = "Pixel Value", y = "Frequency")
ggsave("animal-pixel-lenght-spread4.jpg", plot = p4, dpi = 300, width = 6, height = 4, units = "in")

p5<-ggplot(long5[], aes(x = value)) +
  geom_histogram(color="black", fill="white") +
  facet_wrap(~ name, scales = "free") +
  labs(x = "Pixel Value", y = "Frequency")
ggsave("animal-pixel-lenght-spread5.jpg", plot = p5, dpi = 300, width = 6, height = 4, units = "in")
```
#### spread of each animal's pixel lengths for dermis
```{r, spread-epi-pixel}
df_set1<-all_dermis_lengths_in_pixels[,1:6]
df_set2<-all_dermis_lengths_in_pixels[,7:12]
df_set3<-all_dermis_lengths_in_pixels[,13:18]
df_set4<-all_dermis_lengths_in_pixels[,19:24]
df_set5<-all_dermis_lengths_in_pixels[,25:30]

# convert data to long format using tidyr::pivot_longer()
long1 <- tidyr::pivot_longer(df_set1, everything())
long2 <- tidyr::pivot_longer(df_set2, everything())
long3 <- tidyr::pivot_longer(df_set3, everything())
long4 <- tidyr::pivot_longer(df_set4, everything())
long5 <- tidyr::pivot_longer(df_set5, everything())

# plot using ggplot and facet_wrap()
p1<-ggplot(long1[], aes(x = value)) +
  geom_histogram(color="black", fill="white") +
  facet_wrap(~ name, scales = "free") +
  labs(x = "Pixel Value", y = "Frequency")
p1
ggsave("animal-derm-pixel-length-spread1.jpg", plot = p1, dpi = 300, width = 6, height = 4, units = "in")

p2<-ggplot(long2[], aes(x = value)) +
  geom_histogram(color="black", fill="white") +
  facet_wrap(~ name, scales = "free") +
  labs(x = "Pixel Value", y = "Frequency")
p2
ggsave("animal-derm-pixel-length-spread2.jpg", plot = p2, dpi = 300, width = 6, height = 4, units = "in")

p3<-ggplot(long3[], aes(x = value)) +
  geom_histogram(color="black", fill="white") +
  facet_wrap(~ name, scales = "free") +
  labs(x = "Pixel Value", y = "Frequency")
ggsave("animal-derm-pixel-length-spread3.jpg", plot = p3, dpi = 300, width = 6, height = 4, units = "in")

p4<-ggplot(long4[], aes(x = value)) +
  geom_histogram(color="black", fill="white") +
  facet_wrap(~ name, scales = "free") +
  labs(x = "Pixel Value", y = "Frequency")
ggsave("animal-derm-pixel-length-spread4.jpg", plot = p4, dpi = 300, width = 6, height = 4, units = "in")

p5<-ggplot(long5[], aes(x = value)) +
  geom_histogram(color="black", fill="white") +
  facet_wrap(~ name, scales = "free") +
  labs(x = "Pixel Value", y = "Frequency")
ggsave("animal-derm-pixel-length-spread5.jpg", plot = p5, dpi = 300, width = 6, height = 4, units = "in")
```

### Write function to calculate average length for each column in epidermis and dermis dfs (aka each animal)
```{r, fnc-to-calcualte-averages}
# Define a function to calculate column-wise averages
calculate_averages <- function(data) {
  # Calculate column-wise averages using colMeans() function
  avg <- colMeans(data, na.rm = TRUE)
  
  # Create a new dataframe to store the column-wise averages
  avg_df <- data.frame(column = names(data), average = avg)
  
  # Return the new dataframe
  return(avg_df)
}

# The calculate_averages() function takes one argument data, which is the dataframe for which we want to calculate the column-wise averages.
# 
# The colMeans() function is used to calculate the column-wise averages of the dataframe. The na.rm = TRUE argument specifies that missing values should be removed before calculating the averages.
# 
# We then create a new dataframe avg_df to store the column names and their respective averages. The data.frame() function is used to create the new dataframe with two columns: "column" for the column names, and "average" for the column-wise averages.
# 
# Finally, we return the new dataframe avg_df from the function.
```

### Use previous function to create dataframes with averages for epidermis and dermis df's
```{r, calc-averages}
# Call the calculate_averages() function to calculate the column-wise averages
all_epidermis_in_pixels_AVG <- calculate_averages(all_epidermis_lengths_in_pixels)
colnames(all_epidermis_in_pixels_AVG)<-c("filename", "average")
rownames(all_epidermis_in_pixels_AVG)<-c(1:length(rownames(all_epidermis_in_pixels_AVG)))

all_dermis_in_pixels_AVG <- calculate_averages(all_dermis_lengths_in_pixels)
colnames(all_dermis_in_pixels_AVG)<-c("filename", "average")
rownames(all_dermis_in_pixels_AVG)<-c(1:length(rownames(all_epidermis_in_pixels_AVG)))
```

### Visualize average pixel lengths (per animal) for epidermis/dermis 
Use bar chart
```{r, viz-animal-pixel-averages}
categories <- c(letters[1:16], "r", "u", "v", "w", "x", "y", "z", "z1", "z10", "z2", "z4", "z6", "z8", "z9")

# for epidermis
df1<- cbind(all_epidermis_in_pixels_AVG, categories)
p1<-ggplot(df1, aes(x = categories, y = all_epidermis_in_pixels_AVG[,2])) +
  geom_bar(stat = "identity", color="black", fill="white") +
  xlab("Animal") +
  ylab("Average Length of Epidermis in pixels")
p1

ggsave("avg-epidermis-pixel-length-by-animal.jpg", plot = p1, dpi = 300, width = 6, height = 4, units = "in")

# for dermis
df2<- cbind(all_dermis_in_pixels_AVG, categories)
p2<-ggplot(df2, aes(x = categories, y = all_epidermis_in_pixels_AVG[,2])) +
  geom_bar(stat = "identity", color="black", fill="white") +
  xlab("Animal") +
  ylab("Average Length of Dermis in pixels")
p2

ggsave("avg-dermis-pixel-length-by-animal.jpg", plot = p2, dpi = 300, width = 6, height = 4, units = "in")
```


### save blinded average pixel length df's for epidermis and dermis
```{r, save-blind-avg-pixel-dermis-and-epidermis-dfs}
## ONLY RUN IF DATAFRAMS NOT ALREADY SAVED!

write.csv(df1, file=paste0("../data/","blind_avg_epidermis_lengths_in_pixels.csv"))
write.csv(df2, file=paste0("../data/","blind_avg_dermis_lengths_in_pixels.csv"))
```

### Write funciton to unblind animal identities
__Question__: What is identity of AnimalD? in terms of post-op day?
*Don't forget to add identities for new animals and re-run the rest of the notebook currently they are blank* 
```{r, unblind-fnc}
add_identity_unblind_column <- function(df) {
  # Define a lookup table of filename prefixes and corresponding identity_unblind values
  prefixes <- c("Animal_A" = "Exp17_Racemic-MAP_POD7_Mouse14",
                "Animal_C" = "Exp16_D-MAP_POD4_Mouse3",
                "Animal_D" = "Exp15_L-MAP_Mouse3",
                "Animal_E" = "Exp14_No-MAP_POD7_Mouse11",
                "Animal_F" = "Exp17_Racemic-MAP_POD7_Mouse11",
                "Animal_G" = "Unmanipulated_PepB",
                "Animal_H" = "Exp17_Racemic-MAP_POD4_Mouse2",
                "Animal_I" = "Exp15_L-MAP_POD7_Mouse13",
                "Animal_J" = "Exp15_L-MAP_POD4_Mouse2",
                "Animal_K" = "Exp14_No-MAP_POD4_Mouse4",
                "Animal_L" = "Exp14_No-MAP_POD7_Mouse12",
                "Animal_M" = "Exp14_No-MAP_POD4_Mouse3",
                "Animal_N" = "Unmanip_PepB",
                "Animal_O" = "Exp17_Racemic-MAP_POD7_Mouse13",
                "Animal_U" = "Exp14_No-MAP_POD4_Mouse1",
                "Animal_V" = "Unmanip_B6",
                "Animal_W" = "Exp17_Racemic-MAP_POD7_Mouse12",
                "Animal_X" = "Exp14_No-MAP_POD4_Mouse2",
                "Animal_Y" = "Exp16_D-MAP_POD7_Mouse11",
                "Animal_Z" = "UnmanipB6",
                "Animal_Z1" = "Exp17_Racemic-MAP_POD4_Mouse1",
                "Animal_Z2" = "Exp14_POD7_Mouse14",
                "Animal_Z3" = "Exp15_Mouse12_POD7_LMAP",
                "Animal_Z4" = "Exp15_POD4_Mouse1",
                "Animal_B" = "",
                "Animal_P" = "",
                "Animal_R" = "",
                "Animal_Z6" = "",
                "Animal_Z8" = "",
                "Animal_Z9" = "",
                "Animal_Z10" = "")
  
  # Use sapply to look up the identity_unblind value for each filename in the dataframe
  df$identity_unblind <- sapply(df$filename, function(x) {
    prefix <- substr(x, 1, 8) # Extract the first 8 characters of the filename
    prefixes[prefix] # Look up the corresponding identity_unblind value
  })
  
  return(df)
}

```

### Use previous function to unblind epidermis and dermis df's
```{r, use-unblind-fnc}
unblind_all_epidermis_in_pixels_AVG <- add_identity_unblind_column(all_epidermis_in_pixels_AVG)

unblind_all_dermis_in_pixels_AVG <- add_identity_unblind_column(all_dermis_in_pixels_AVG)
```

### save the unblind epidermis and dermis dfs
```{r, save-ublinded-dfs}
# ONLY RUN IF THESE DF's AREN'T ALREADY SAVED!!
write.csv(unblind_all_epidermis_in_pixels_AVG, file=paste0("../data/","unblind_avg_epidermis_lengths_in_pixels.csv"))

write.csv(unblind_all_dermis_in_pixels_AVG, file=paste0("../data/","unblind_avg_dermis_lengths_in_pixels.csv"))
```

### Prism graphs
#### Write function to filter data for prism
```{r, filter-prism-fnc}
# get only the unmanip
filter_data_by_phrase <- function(df, phrase) {
  filtered_df <- df[grep(phrase, df$identity_unblind), ]
  return(filtered_df)
}

# This function takes two parameters: df, which is the data frame to be filtered, and phrase, which is the phrase to search for in the "identity_unblind" column. The grep() function is used to search for the given phrase in the "identity_unblind" column, and the resulting indices are used to subset the original data frame.
```

#### Wrtie fucntion to deal with different lengths for filtered data made for prism
```{r, df-length-fnc}
create_dataframe <- function(vec1, vec2, vec3, vec4, vec5) {
  # Get the maximum length of the vectors
  max_length <- max(length(vec1), length(vec2), length(vec3), length(vec4), length(vec5))
  
  # Pad shorter vectors with NAs
  vec1 <- c(vec1, rep(NA, max_length - length(vec1)))
  vec2 <- c(vec2, rep(NA, max_length - length(vec2)))
  vec3 <- c(vec3, rep(NA, max_length - length(vec3)))
  vec4 <- c(vec4, rep(NA, max_length - length(vec4)))
  vec5 <- c(vec5, rep(NA, max_length - length(vec5)))
  
  # Create the data frame
  df <- data.frame(vec1, vec2, vec3, vec4, vec5)
  return(df)
}

```

#### Use the previous two functions to filter data for prism
```{r, use-filter-prism-fnc}
p1<- "Unmanip"
p2<-"No-MAP"
p3<-"L-MAP"
p4<-"D-MAP"
p5<-"Racemic-MAP"

# for epiderm

# deal with different lengths
all_epidermal_pixel_thickness_prismDf<-create_dataframe((filter_data_by_phrase(unblind_all_epidermis_in_pixels_AVG, p1))$average,
      (filter_data_by_phrase(unblind_all_epidermis_in_pixels_AVG, p2))$average,
      (filter_data_by_phrase(unblind_all_epidermis_in_pixels_AVG, p3))$average,
      (filter_data_by_phrase(unblind_all_epidermis_in_pixels_AVG, p4))$average,
      (filter_data_by_phrase(unblind_all_epidermis_in_pixels_AVG, p5))$average)
colnames(all_epidermal_pixel_thickness_prismDf) <- c("NonOp", "No MAP", "L-MAP", "D-MAP", "R-MAP")
View(all_epidermal_pixel_thickness_prismDf)

# for derm
all_dermal_pixel_thickness_prismDf<-create_dataframe((filter_data_by_phrase(unblind_all_dermis_in_pixels_AVG, p1))$average,
      (filter_data_by_phrase(unblind_all_dermis_in_pixels_AVG, p2))$average,
      (filter_data_by_phrase(unblind_all_dermis_in_pixels_AVG, p3))$average,
      (filter_data_by_phrase(unblind_all_dermis_in_pixels_AVG, p4))$average,
      (filter_data_by_phrase(unblind_all_dermis_in_pixels_AVG, p5))$average)
colnames(all_dermal_pixel_thickness_prismDf) <- c("NonOp", "No MAP", "L-MAP", "D-MAP", "R-MAP")
View(all_dermal_pixel_thickness_prismDf)
```

#### save the prism df's made in the previous chunk
```{r, save-prism-dfs}
# ONLY RUN IF THESE DF's AREN'T ALREADY SAVED!!
write.csv(epidermal_thickness_prismDf, file=paste0("../data/","all_epidermal_pixel_thickness_prismDf.csv"))

write.csv(dermal_thickness_prismDf, file=paste0("../data/","all_dermal_pixel_thickness_prismDf.csv"))
```


